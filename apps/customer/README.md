# 顧客向けセルフオーダーアプリ

テーブルのQRコードをスキャンして、メニューから注文できる顧客向けアプリです。

## 機能概要

### 1. QRコードログイン (`/scan`)
- テーブルのQRコードをカメラでスキャン
- 手動入力フォーム（テスト用・カメラ使用不可時）
- 自動でメニューページへリダイレクト

### 2. メニュー・注文 (`/menu`)
- カテゴリ別メニュー表示
- カート機能（追加・削除・数量変更）
- 合計金額リアルタイム計算
- 注文送信

### 3. 注文状況確認 (`/orders`)
- 注文一覧表示
- 5秒ごとの自動更新（ポーリング）
- ステータス別表示:
  - 📝 注文受付済み
  - 🍳 調理中
  - ✅ 調理完了
  - 🍽️ 配膳済み
  - 💳 会計済み

## 技術スタック

- **Framework**: Next.js 14 (App Router)
- **Language**: TypeScript
- **Styling**: Tailwind CSS
- **QR Scanner**: html5-qrcode
- **Authentication**: JWT (localstorage)
- **Real-time Updates**: Polling (5秒間隔)

## セットアップ

### 前提条件
- Node.js 18+
- pnpm

### インストール

```bash
# 依存関係インストール（monorepo root から）
cd /workspace/front
pnpm install
```

### 開発サーバー起動

```bash
# 顧客アプリのみ起動
pnpm -F customer dev

# または全アプリ起動
pnpm dev
```

アプリは http://localhost:3004 で起動します。

## ディレクトリ構成

```
apps/customer/
├── app/
│   ├── scan/                 # QRスキャンページ
│   │   └── page.tsx
│   ├── menu/                 # メニュー・カートページ
│   │   └── page.tsx
│   └── orders/               # 注文状況ページ
│       └── page.tsx
├── components/
│   └── QRScanner.tsx         # QRスキャナーコンポーネント
├── hooks/
│   └── usePolling.ts         # ポーリングフック
└── tsconfig.json
```

## API エンドポイント

### 認証
- `POST /api/customer/auth/login_via_qr` - QRログイン
- `POST /api/customer/auth/logout` - ログアウト

### メニュー
- `GET /api/customer/menu_items` - 利用可能メニュー一覧

### 注文
- `POST /api/customer/orders` - 注文作成
- `GET /api/customer/orders` - 自分のテーブルの注文一覧（未払いのみ）

## セキュリティ

### テーブルセッション管理
- **店員が顧客を案内した時**にテーブルセッションを作成
- QRログインは既存のアクティブなセッションが必要
- セッションがない場合: 「店員にお声がけください」エラー

### テーブルスコープアクセス制御
- 顧客は自分のテーブルセッションの注文のみ閲覧・作成可能
- JWTトークンに`table_id`と`table_session_id`を含む
- バックエンドで`current_table_session`を検証

### JWT構造
```json
{
  "table_id": 21,
  "table_session_id": 45,
  "tenant_id": 1,
  "store_id": 1,
  "user_type": "customer",
  "exp": 1767013282
}
```

### ローカルストレージ
- `customer_token`: JWT認証トークン
- `customer_session`: セッション情報
  - `table_id`: テーブルID
  - `table_number`: テーブル番号
  - `table_session_id`: セッションID（重要）
  - `store_id`, `store_name`: 店舗情報
  - `tenant_id`, `tenant_name`: テナント情報

## 使用方法

### 顧客の利用フロー

**前提: 店員が顧客をテーブルに案内済み**（店員がTableSessionを作成）

1. **QRコードスキャン**
   - テーブルのQRコードをスキャン
   - 既存のセッションに紐付け→メニューページへ
   - ⚠️ セッション未作成の場合: 「店員にお声がけください」エラー

2. **メニュー閲覧・注文**
   - カテゴリ別にメニューを表示
   - カートに商品を追加
   - 「注文する」ボタンで送信

3. **注文状況確認**
   - 「注文状況を見る」ボタンをクリック
   - リアルタイムで調理状況を確認

4. **会計**
   - 「お会計」タブで合計金額を確認
   - スタッフに画面を見せて会計
   - スタッフがテーブルセッションを終了

### テスト用QRコード

開発環境では、以下のQRコードでテストできます:
```
1-1-T1-fd0de71dfcd4d7db
```

このコードを手動入力フォームに貼り付けてテストしてください。

## トラブルシューティング

### カメラが起動しない
- ブラウザのカメラ権限を確認
- HTTPSが必要（localhostは除く）
- 手動入力フォームを使用

### 注文が更新されない
- ネットワーク接続を確認
- ブラウザの開発者ツールでAPIエラーを確認
- 「今すぐ更新」ボタンで手動更新

### ログインできない
- QRコードが正しいか確認
- テーブルのステータスが`available`または`reserved`か確認
- バックエンドサーバーが起動しているか確認

## 今後の実装予定（拡張機能）

### 🚀 優先度：高

#### 1. 会計処理の連携強化
- [ ] スタッフ側での会計完了処理
- [ ] テーブルステータス自動リセット
- [ ] レシート発行機能

---

### 🎨 優先度：中（各ページの拡張）

#### 2. メニューページ (`/menu`) の拡張
- [x] メニュー画像の表示
- [x] アレルギー情報・辛さレベル表示
- [x] 商品詳細モーダル
- [ ] 注文時のメモ機能（「氷少なめ」など）

#### 3. 注文履歴ページ (`/history`) の追加
- [ ] 過去の注文（会計済み）表示
- [ ] 再注文機能（ワンクリックで同じ注文）
- [ ] 注文の絞り込み・検索

#### 4. PWA対応
- [ ] オフライン対応
- [ ] ホーム画面に追加
- [ ] プッシュ通知（調理完了時）

#### 5. 多言語対応
- [ ] 英語・中国語・韓国語
- [ ] 自動言語検出

---

### 📊 優先度：低（将来的な拡張）

#### 6. 会員登録・ログイン機能（オプション）
- [ ] 会員登録・ログイン画面
- [ ] SNS連携（Google, LINE, Twitter）
- [ ] お気に入りメニュー
- [ ] ポイント制度

#### 7. 予約システム
- [ ] テーブル予約
- [ ] 事前注文

#### 8. その他
- [ ] オンライン決済統合
- [ ] ダークモード
- [ ] 在庫連動（品切れメニューの自動非表示）

---

## ✅ 完了済み（基本機能）

### 認証・セッション
- [x] QRコードスキャンログイン (`/scan`)
- [x] セッション管理（localStorage）
- [x] JWTトークン認証
- [x] テーブルスコープアクセス制御

### メニュー閲覧ページ (`/menu`)
- [x] メニュー一覧表示
- [x] カテゴリー別グループ表示
- [x] カテゴリーナビゲーション（固定・スクロール）
- [x] カテゴリー表示順設定（`category_order`）
- [x] 商品情報表示（名前・価格・説明）
- [x] 商品画像表示（image_url）
- [x] 辛さレベル表示（🌶️絵文字、0-5段階）
- [x] アレルゲン情報表示（⚠️絵文字付き）
- [x] 商品詳細モーダル（クリックで拡大表示・詳細説明）
- [x] カート機能（追加・削除・数量変更・ゴミ箱アイコン）
- [x] 固定カートボタン（右下・タブバーの上）
- [x] カート内アイテム数バッジ表示
- [x] カート表示中のボタン非表示
- [x] 合計金額のリアルタイム計算
- [x] 注文送信機能

### 注文状況ページ (`/orders`)
- [x] 未払い注文の一覧表示
- [x] 5秒ポーリングでの自動更新
- [x] ステータス別表示（注文受付・調理中・調理完了・配膳済み）
- [x] 注文詳細表示（商品名・数量・金額）
- [x] 手動更新ボタン
- [x] 注文キャンセル機能（調理前のみ）
- [x] キャンセル理由入力
- [x] キャンセル済み注文の表示

### 会計ページ (`/payment`)
- [x] 会計画面の表示
- [x] 合計金額の大きな表示
- [x] 注文内訳の表示
- [x] スタッフ提示用デザイン

### UI/UX
- [x] 下部固定タブバー（メニュー・注文状況・お会計・呼出）
- [x] 店員呼び出しボタン（基本版・確認ダイアログ）
- [x] 店員呼び出し機能の強化（呼び出しタイプ選択・音声・バイブレーション）
- [x] レスポンシブデザイン
- [x] ローディング表示
- [x] エラーハンドリング

### アクティビティログ・監査ログ
- [x] 顧客行動ログの記録（閲覧のみ不可）
- [x] QRログイン・ログアウトの記録
- [x] メニュー閲覧ログの記録
- [x] 注文作成ログの記録（OrdersControllerで実装）

**記録される操作ログ（Customerアプリ）**:
- ✅ **認証**:
  - QRログイン成功（テーブルID・セッションID・店舗情報）
  - QRログイン失敗（QRコード・失敗理由）
  - ログアウト（テーブルID・セッションID）
- ✅ **閲覧ログ**:
  - メニュー一覧閲覧（ページアクセス・表示件数）
- ✅ **注文作成**:
  - 注文送信（注文番号・金額・商品数・テーブルID）※OrdersControllerで記録
  - 注文キャンセル（注文番号・金額・キャンセル理由）
- ✅ **店員呼び出し**:
  - スタッフ呼び出し（テーブル番号・呼び出しタイプ・メモ）
- 🔍 **閲覧権限**: なし（顧客自身はログを閲覧できません）
  - 店舗スタッフ: 自店舗の顧客ログを閲覧可能
  - テナント管理者: 自テナント配下の全顧客ログを閲覧可能
  - システム管理者: 全顧客ログを閲覧可能

**用途**:
- 「見たけど頼まなかった商品」の分析
- QRログイン成功率の分析
- 顧客の滞在時間・行動パターン分析
- セキュリティ監査（不正アクセス検知）

## ライセンス

このプロジェクトは開発中です。
